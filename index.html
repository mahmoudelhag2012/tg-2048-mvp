<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Mini — MVP</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- AdsGram SDK -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <!-- Telega.io SDK -->
  <script src="https://inapp.telega.io/sdk/v1/sdk.js"></script>
  <script>
    /* ===== Telega init ===== */
    var telegaAds = null;
    if (window.TelegaIn && window.TelegaIn.AdsController) {
      telegaAds = window.TelegaIn.AdsController.create_miniapp({
        token: 'a14e3947-839f-4b2a-aee0-5a3b1412c818'
      });
    }

    /* Telega Ad Block UIDs (بدّلهم لو هتعمل بلوكات مخصّصة) */
    const TELEG_UID_1024 = "3a1f1a7a-028c-4909-b20b-f4733d02fcc5";
    const TELEG_UID_2048 = "6a5cb9ac-15d0-4da2-bbca-916236f1bc83";

    /* Helper: show Telega ad (يدعم الطريقتين) */
    function showTelega(uid) {
      try {
        if (window.ads && typeof window.ads.ad_show === "function") {
          return window.ads.ad_show({ adBlockUuid: uid });
        } else if (telegaAds && typeof telegaAds.show === "function") {
          return telegaAds.show();
        }
      } catch(e) {
        console.warn("Telega show error:", e);
      }
      return Promise.resolve();
    }
  </script>

  <style>
    body{font-family:system-ui,Arial;padding:16px;margin:0;background:#faf8ef;color:#776e65;}
    .wrap{max-width:420px;margin:0 auto;text-align:center}
    h1{margin:0 0 8px}
    .top{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .card{background:#bbada0;color:#fff;border-radius:12px;padding:8px 12px;min-width:100px}
    .grid{background:#bbada0;border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;touch-action:none}
    .cell{height:80px;background:#cdc1b4;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px}
    .btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    button{padding:10px;border:0;border-radius:10px;font-weight:700;background:#8f7a66;color:#fff;cursor:pointer}
    small{opacity:.7}
    .row{display:flex;gap:8px;justify-content:center;margin-top:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>2048 Mini</h1>
  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="btns">
    <span></span><button id="up">▲</button><span></span>
    <button id="left">◀</button><button id="down">▼</button><button id="right">▶</button>
    <button id="new">New Game</button><button id="share">Share</button><button id="about">About</button>
  </div>
  <div class="row">
    <button id="invite">Invite Friend</button>
  </div>
  <p><small>Swipe on the board or use the arrows. MVP build.</small></p>
</div>

<script>
/* ===== Telegram ===== */
const tg = window.Telegram?.WebApp; if (tg) tg.expand();
const tgUserId   = tg?.initDataUnsafe?.user?.id || null;
const startParam = tg?.initDataUnsafe?.start_param || null;

/* ===== Game State ===== */
const size=4; let grid=[], score=0, best=+localStorage.getItem('best2048')||0;
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');

/* Flags / Rewards */
let continuedOnce   = false; // AdsGram one-time continue on game over
let shown1024Ad     = false; // Telega milestone at 1024
let shown2048Ad     = false; // Telega milestone at 2048
let bonus1024Given  = false; // +100 points on first time 1024 appears
let extraLives      = 0;     // From 512 reward or referral
let offered512      = false; // Offer extra-life at 512 once per run

/* ===== Invite / Referral ===== */
function buildInviteLink(){
  const refCode = tgUserId ? `ref_${tgUserId}` : `ref_anon`;
  return `https://t.me/Smart2048_bot/myapp?startapp=${encodeURIComponent(refCode)}`;
}
document.getElementById('invite').onclick = () => {
  const link = buildInviteLink();
  const msg = `Come play 2048 Mini!\nInvite link: ${link}`;
  if (navigator.share) { navigator.share({ text: msg, url: link }).catch(()=>copyFallback()); }
  else { copyFallback(); }
  function copyFallback(){ prompt('Copy your invite link:', link); }
};

// If opened via referral: grant +1 life (after rewarded ad) & notify bot to credit inviter
function handleReferralOpen(){
  if (!startParam || !startParam.startsWith('ref_')) return;
  const inviterId = startParam.substring(4);
  const onceKey = `ref_seen_from_${inviterId}`;
  if (tgUserId && String(tgUserId) === String(inviterId)) return; // self
  if (localStorage.getItem(onceKey)) return; // already processed

  const want = confirm("You joined via a friend's invite.\nWatch an ad to grant them an Extra Life?\nYou'll also get +1 Extra Life.");
  if (!want) { localStorage.setItem(onceKey, '1'); return; }

  showRewardAd().then(ok=>{
    localStorage.setItem(onceKey, '1');
    if (ok){
      extraLives += 1; // invitee life
      alert("✅ Extra Life added! (You now have " + extraLives + ")");
      try {
        if (tg && typeof tg.sendData === 'function') {
          tg.sendData(JSON.stringify({
            type: 'ref_credit',
            inviterId,
            viewerId: tgUserId || 'anon',
            ts: Date.now()
          }));
        }
      } catch(e){}
    }
  });
}

/* ===== Daily Reward (once per day) via Telega ad) ===== */
function checkDailyReward(){
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const last  = localStorage.getItem("lastDailyReward");
  if (last === today) return;

  const want = confirm("🎁 Daily Reward! Watch an ad to claim +200 points.");
  // تظهر أول اليوم فقط: نعلّم حتى لو رفض
  localStorage.setItem("lastDailyReward", today);

  if (want){
    // ممكن تعمل UID خاص للـ Daily. هنا بنستخدم TELEG_UID_1024 كافتراضي.
    showTelega(TELEG_UID_1024)
      .then(()=>{
        score += 200;
        updateBest();
        draw();
        alert("✅ +200 points added!");
      })
      .catch(()=>{ /* لو الإعلان فشل مش هنضيف نقاط */ });
  }
}

/* ===== Core game ===== */
function emptyGrid(){grid=Array.from({length:size},()=>Array(size).fill(0));}
function randomEmpty(){const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])e.push([r,c]); return e.length?e[Math.floor(Math.random()*e.length)]:null;}
function addTile(){const pos=randomEmpty(); if(!pos) return false; grid[pos[0]][pos[1]] = Math.random()<0.9?2:4; return true;}
function setup(){
  emptyGrid(); addTile(); addTile();
  score=0; continuedOnce=false; shown1024Ad=false; shown2048Ad=false;
  bonus1024Given=false; offered512=false;
  draw();
  handleReferralOpen();   // referral system
  checkDailyReward();     // 🔔 Daily Reward with Telega ad
}

function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||'';
    d.style.background=v?tileColor(v):'#cdc1b4';
    d.style.color=v>=8?'#f9f6f2':'#776e65';
    gridEl.appendChild(d);

    // 512 → optional Extra Life via AdsGram Reward (once per run)
    if (v === 512 && !offered512) {
      offered512 = true;
      const want = confirm("Nice! You reached 512.\nWatch an ad to get 1 Extra Life?\n(You can skip and continue without it.)");
      if (want) {
        showRewardAd().then(ok=>{
          if (ok){
            extraLives += 1;
            alert("✅ Extra Life granted! (You now have " + extraLives + ")");
          }
        });
      }
    }

    // 1024 → Telega ad + +100 points (once)
    if (v === 1024) {
      if (!shown1024Ad) { shown1024Ad = true; showTelega(TELEG_UID_1024); }
      if (!bonus1024Given) {
        bonus1024Given = true;
        score += 100;
        alert("🎉 Milestone reached: 1024!\nBonus +100 points added.");
        scoreEl.textContent = score;
      }
    }

    // 2048 → Telega ad (once)
    if (v === 2048 && !shown2048Ad) {
      shown2048Ad = true;
      showTelega(TELEG_UID_2048);
    }
  }
}
function tileColor(v){
  const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
  return m[v]||'#3c3a32';
}
function slide(row){
  const f=row.filter(x=>x);
  for(let i=0;i<f.length-1;i++){
    if(f[i]===f[i+1]){ f[i]*=2; score+=f[i]; f.splice(i+1,1); }
  }
  while(f.length<size) f.push(0);
  return f;
}
function rotate(times){
  for(let t=0;t<times;t++){
    const g=Array.from({length:size},()=>Array(size).fill(0));
    for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c];
    grid=g;
  }
}

/* ===== Directions (fixed): 0 L, 1 U, 2 R, 3 D ===== */
function move(dir){
  const before = JSON.stringify(grid);

  if (dir === 2) {         // right
    rotate(2);
  } else if (dir === 1) {  // up
    rotate(3);
  } else if (dir === 3) {  // down
    rotate(1);
  }

  for (let r = 0; r < size; r++) grid[r] = slide(grid[r]);

  if (dir === 2) {
    rotate(2);
  } else if (dir === 1) {
    rotate(1);
  } else if (dir === 3) {
    rotate(3);
  }

  const after = JSON.stringify(grid);
  if (before !== after) {
    addTile();
    updateBest();
    draw();
    if (gameOver()) endGame();
  }
}

function gameOver(){
  if(randomEmpty()) return false;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    if(r+1<size && grid[r+1][c]===v) return false;
    if(c+1<size && grid[r][c+1]===v) return false;
  }
  return true;
}
function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048', best); }}

/* ===== Inputs ===== */
const startPos={x:0,y:0}; let dragging=false;
function touchStart(e){dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY;}
function touchEnd(e){
  if(!dragging) return; dragging=false;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y;
  if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?2:0); } else { move(dy>0?3:1); }
}
document.getElementById('left').onclick=()=>move(0);
document.getElementById('up').onclick=()=>move(1);
document.getElementById('right').onclick=()=>move(2);
document.getElementById('down').onclick=()=>move(3);
document.getElementById('new').onclick=()=>setup();
document.getElementById('about').onclick=()=>alert('2048 Mini — MVP.');
document.getElementById('share').onclick=()=>{
  const link = buildInviteLink();
  const text=`I scored ${score} in 2048 Mini! Play here: ${link}`;
  if(navigator.share){navigator.share({text, url: link});}
  else {prompt('Copy and share:', text);}
};
gridEl.addEventListener('touchstart',touchStart); gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart); gridEl.addEventListener('mouseup',touchEnd);

/* ===== AdsGram: interstitial & reward ===== */
let AdController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  AdController = window.Adsgram.init({ blockId: "int-14155" });
}
function showInterstitialAd(){
  if (!AdController || typeof AdController.show !== "function") return Promise.resolve();
  return AdController.show().catch(()=>{});
}
let RewardController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  RewardController = window.Adsgram.init({ blockId: "14159" }); // Reward block
}
function showRewardAd(){
  if (!RewardController || typeof RewardController.show !== "function") {
    return Promise.resolve(false);
  }
  return RewardController.show()
    .then(()=> true)
    .catch(()=> false);
}

/* ===== Revive logic ===== */
function reviveBoard(){
  const filled=[];
  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(grid[r][c]!==0) filled.push([r,c]);
  }
  if(filled.length){
    const [rr,cc]=filled[Math.floor(Math.random()*filled.length)];
    grid[rr][cc]=0; // free exactly one tile
  }
  updateBest();
}

/* ===== endGame flow ===== */
function endGame(){
  // 1) Use any stored Extra Life (from 512 or referral)
  if (extraLives > 0) {
    const useIt = confirm("Game over! Use your Extra Life to continue?");
    if (useIt) {
      extraLives -= 1;
      reviveBoard();
      draw();
      return;
    }
  }

  // 2) Otherwise, one-time AdsGram rewarded continue
  if (!continuedOnce && RewardController) {
    const wantContinue = confirm("Game over! Your score: " + score + "\n\nWatch an ad to continue?");
    if (wantContinue) {
      showRewardAd().then(ok=>{
        if (ok){
          continuedOnce = true;
          reviveBoard();
          draw();
        }else{
          showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
        }
      });
      return;
    } else {
      showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
      return;
    }
  }

  // 3) No revives left → interstitial + end
  showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
}

/* ===== Start ===== */
setup();
</script>
</body>
</html>
