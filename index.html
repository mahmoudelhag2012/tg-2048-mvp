<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Mini — MVP</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- AdsGram SDK -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <!-- Telega.io SDK -->
  <script src="https://inapp.telega.io/sdk/v1/sdk.js"></script>

  <script>
    // ========= Telega init & ready helper =========
    let telegaReadyResolve;
    const telegaReady = new Promise(res => (telegaReadyResolve = res));

    // Telega miniapp controller (fallback API)
    let telegaAds = null;

    function markTelegaReady() {
      try {
        if (window.TelegaIn && window.TelegaIn.AdsController && !telegaAds) {
          telegaAds = window.TelegaIn.AdsController.create_miniapp({
            token: 'a14e3947-839f-4b2a-aee0-5a3b1412c818'
          });
        }
      } catch(e) {}
      telegaReadyResolve && telegaReadyResolve();
    }

    // SDKs قد تتأخر.. نعتبر جاهز لما window.ads أو telegaAds يتوفروا
    (function waitTelegaSDK(attempts=0){
      if ((window.ads && typeof window.ads.ad_show === "function") || (window.TelegaIn && window.TelegaIn.AdsController)) {
        markTelegaReady();
      } else if (attempts < 40) { // ~2s
        setTimeout(()=>waitTelegaSDK(attempts+1), 50);
      } else {
        // نكمّل من غير ما نكسر اللعبة
        telegaReadyResolve && telegaReadyResolve();
      }
    })();

    // UIDs الخاصة ببلوكات Telega
    const TELEG_UID_1024 = "3a1f1a7a-028c-4909-b20b-f4733d02fcc5";
    const TELEG_UID_2048 = "6a5cb9ac-15d0-4da2-bbca-916236f1bc83";

    // دالة مساعدة: تحاول تستخدم طريقة Telega المناسبة المتاحة
    function showTelega(uid) {
      return telegaReady.then(() => {
        try {
          if (window.ads && typeof window.ads.ad_show === "function") {
            // الاسم الصحيح للخاصية: adBlockUuid (مش adBlockUid)
            return window.ads.ad_show({ adBlockUuid: uid });
          } else if (telegaAds && typeof telegaAds.show === "function") {
            return telegaAds.show();
          }
        } catch(e) {
          console.warn("Telega show error:", e);
        }
        return Promise.resolve(); // ما نعطّلش اللعبة لو الإعلان مش جاهز
      });
    }

    // قراءة start param (للّدعوات)
    function getStartParam() {
      try {
        const tg = window.Telegram?.WebApp;
        const p1 = tg?.initDataUnsafe?.start_param;
        if (p1) return p1;
      } catch(e){}
      const u = new URL(location.href);
      return u.searchParams.get('startapp') || u.searchParams.get('ref') || '';
    }
  </script>

  <style>
    body{font-family:system-ui,Arial;padding:16px;margin:0;background:#faf8ef;color:#776e65;}
    .wrap{max-width:420px;margin:0 auto;text-align:center}
    h1{margin:0 0 8px}
    .top{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .card{background:#bbada0;color:#fff;border-radius:12px;padding:8px 12px;min-width:110px}
    .grid{background:#bbada0;border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;touch-action:none}
    .cell{height:80px;background:#cdc1b4;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px}
    .btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    button{padding:10px;border:0;border-radius:10px;font-weight:700;background:#8f7a66;color:#fff;cursor:pointer}
    small{opacity:.7}
    .toolbar{display:flex;gap:8px;justify-content:center;margin:10px 0 0}
    .toolbar button{background:#6b5b4a}
  </style>
</head>
<body>
<div class="wrap">
  <h1>2048 Mini</h1>
  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
    <div class="card">Lives<br><b id="lives">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="btns">
    <span></span><button id="up">▲</button><span></span>
    <button id="left">◀</button><button id="down">▼</button><button id="right">▶</button>
    <button id="new">New Game</button><button id="share">Share</button><button id="about">About</button>
  </div>

  <div class="toolbar">
    <button id="invite">Invite Friend</button>
  </div>

  <p><small>Swipe on the board or use the arrows. MVP build.</small></p>
</div>

<script>
/* ===== Telegram ===== */
const tg = window.Telegram?.WebApp; if (tg) tg.expand();

/* ===== Game State ===== */
const size=4; let grid=[], score=0, best=+localStorage.getItem('best2048')||0;
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');
const livesEl=document.getElementById('lives');

let extraLives = +localStorage.getItem('extraLives') || 0;
let continuedOnce = false;          // AdsGram reward continue once/run
let shown512Offer = false;          // optional extra life at 512 (Telega)
let shown1024Ad  = false;           // auto Telega at 1024
let shown2048Ad  = false;           // auto Telega at 2048

function saveLives(){ localStorage.setItem('extraLives', String(extraLives)); livesEl.textContent = String(extraLives); }
function emptyGrid(){grid=Array.from({length:size},()=>Array(size).fill(0));}
function randomEmpty(){const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])e.push([r,c]); return e.length?e[Math.floor(Math.random()*e.length)]:null;}
function addTile(){const pos=randomEmpty(); if(!pos) return false; grid[pos[0]][pos[1]] = Math.random()<0.9?2:4; return true;}
function setup(){emptyGrid(); addTile(); addTile(); score=0; continuedOnce=false; shown512Offer=false; shown1024Ad=false; shown2048Ad=false; draw();}

function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best; saveLives();
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||'';
    d.style.background=v?tileColor(v):'#cdc1b4';
    d.style.color=v>=8?'#f9f6f2':'#776e65';
    gridEl.appendChild(d);

    // 512: optional extra life (Telega)
    if (v === 512 && !shown512Offer) {
      shown512Offer = true;
      setTimeout(()=>{
        const ok = confirm("Milestone 512! Watch an ad to get 1 Extra Life?");
        if (ok){
          showTelega(TELEG_UID_1024).then(()=>{
            extraLives += 1;
            saveLives();
            alert("✅ Extra Life added!");
          });
        }
      }, 0);
    }

    // 1024: auto Telega + small bonus
    if (v === 1024 && !shown1024Ad) {
      shown1024Ad = true;
      showTelega(TELEG_UID_1024).then(()=>{
        score += 100;
        draw();
      });
    }

    // 2048: auto Telega
    if (v === 2048 && !shown2048Ad) {
      shown2048Ad = true;
      showTelega(TELEG_UID_2048).catch(()=>{});
    }
  }
}
function tileColor(v){
  const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
  return m[v]||'#3c3a32';
}
function slide(row){
  const f=row.filter(x=>x);
  for(let i=0;i<f.length-1;i++){
    if(f[i]===f[i+1]){ f[i]*=2; score+=f[i]; f.splice(i+1,1); }
  }
  while(f.length<size) f.push(0);
  return f;
}
function rotate(times){
  for(let t=0;t<times;t++){
    const g=Array.from({length:size},()=>Array(size).fill(0));
    for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c];
    grid=g;
  }
}

/* ===== Directions (fixed): 0 L, 1 U, 2 R, 3 D ===== */
function move(dir){
  const before = JSON.stringify(grid);

  if (dir === 2) {         // right
    rotate(2);
  } else if (dir === 1) {  // up
    rotate(3);
  } else if (dir === 3) {  // down
    rotate(1);
  }

  for (let r = 0; r < size; r++) grid[r] = slide(grid[r]);

  if (dir === 2) {
    rotate(2);
  } else if (dir === 1) {
    rotate(1);
  } else if (dir === 3) {
    rotate(3);
  }

  const after = JSON.stringify(grid);
  if (before !== after) {
    addTile();
    updateBest();
    draw();
    if (gameOver()) endGame();
  }
}

function gameOver(){
  if(randomEmpty()) return false;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    if(r+1<size && grid[r+1][c]===v) return false;
    if(c+1<size && grid[r][c+1]===v) return false;
  }
  return true;
}
function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048', best); }}

/* ===== Inputs ===== */
const startPos={x:0,y:0}; let dragging=false; const TH=18;
function touchStart(e){dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY;}
function touchEnd(e){
  if(!dragging) return; dragging=false;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y;
  if(Math.abs(dx) < TH && Math.abs(dy) < TH) return;
  if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?2:0); } else { move(dy>0?3:1); }
}
document.getElementById('left').onclick=()=>move(0);
document.getElementById('up').onclick=()=>move(1);
document.getElementById('right').onclick=()=>move(2);
document.getElementById('down').onclick=()=>move(3);
document.getElementById('new').onclick=()=>setup();
document.getElementById('about').onclick=()=>alert('2048 Mini — MVP.');
document.getElementById('share').onclick=()=>{
  const text=`I scored ${score} in 2048 Mini!`;
  if(navigator.share){navigator.share({text});}
  else {prompt('Copy and share your score:', text);}
};
document.getElementById('invite').onclick=inviteFriend;
gridEl.addEventListener('touchstart',touchStart); gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart); gridEl.addEventListener('mouseup',touchEnd);

/* ===== AdsGram: Interstitial + Reward ===== */
let AdController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  AdController = window.Adsgram.init({ blockId: "int-14155" }); // interstitial
}
function showInterstitialAd(){
  if (!AdController || typeof AdController.show !== "function") return Promise.resolve();
  return AdController.show().catch(()=>{});
}

let RewardController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  RewardController = window.Adsgram.init({ blockId: "14159" }); // reward
}
function showRewardAd(){
  if (!RewardController || typeof RewardController.show !== "function") return Promise.resolve(false);
  return RewardController.show().then(()=>true).catch(()=>false);
}

/* ===== Revive helpers ===== */
function reviveBoard(){
  const filled=[];
  for(let r=0;r<size;r++) for(let c=0;c<size;c++){
    if(grid[r][c]!==0) filled.push([r,c]);
  }
  if(filled.length){
    const [rr,cc]=filled[Math.floor(Math.random()*filled.length)];
    grid[rr][cc]=0;
  }
  updateBest();
}

/* ===== Game Over Flow ===== */
function endGame(){
  if (extraLives > 0){
    const useLife = confirm("Game over! You have an Extra Life. Use it to continue?");
    if (useLife){
      extraLives -= 1; saveLives();
      reviveBoard(); draw();
      return;
    }
  }
  if (!continuedOnce && RewardController) {
    const wantContinue = confirm("Game over! Watch an ad to continue?");
    if (wantContinue) {
      showRewardAd().then(ok=>{
        if (ok){
          continuedOnce = true;
          reviveBoard();
          draw();
        } else {
          showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
        }
      });
      return;
    }
  }
  showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
}

/* ===== Daily Reward (Telega) ===== */
function checkDailyReward() {
  const today = new Date().toDateString();
  const lastClaim = localStorage.getItem("dailyRewardDate");
  if (lastClaim !== today) {
    alert("🎁 Daily Reward! Watch an ad to claim +200 points.");
    showTelega(TELEG_UID_1024).then(()=>{
      score += 200;
      localStorage.setItem("dailyRewardDate", today);
      draw();
    }).catch(()=>{ /* لو الإعلان فشل، مش هنضيف البونص */ });
  }
}

/* ===== Invite Friend (share link) ===== */
// ملحوظة: مكافأة الداعي نفسه تحتاج باك-إند. مؤقتًا بندي Extra Life للمدعو.
function inviteFriend(){
  const uid = tg?.initDataUnsafe?.user?.id || Math.floor(Math.random()*1e9);
  const link = `https://t.me/Smart2048_bot/myapp?startapp=ref-${uid}`;
  const msg = `Invite a friend to play 2048 Mini!\n\nInvite link:\n${link}`;

  if (tg && typeof tg.openTelegramLink === 'function') {
    tg.openTelegramLink(link);
  } else if (navigator.share) {
    navigator.share({ text: msg }).catch(()=>{ prompt('Copy invite link:', link); });
  } else {
    prompt('Copy invite link:', link);
  }
}

/* ===== Claim invite reward for invitee (no backend) ===== */
function checkInviteRewardForInvitee(){
  const sp = getStartParam(); // e.g., "ref-12345"
  if (sp && sp.startsWith('ref-') && !localStorage.getItem('claimedInviteOnce')){
    const ok = confirm("You were invited! Watch an ad to claim 1 Extra Life?");
    if (ok){
      showTelega(TELEG_UID_1024).then(()=>{
        extraLives += 1; saveLives();
        localStorage.setItem('claimedInviteOnce','1');
        alert("✅ Extra Life added!");
      });
    }
  }
}

/* ===== Start ===== */
setup();
checkDailyReward();
checkInviteRewardForInvitee();
</script>
</body>
</html>
