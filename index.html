<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Mini â€” MVP</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- AdsGram SDK -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <!-- Telega.io SDK (Ù…ÙˆØ¬ÙˆØ¯ ÙƒÙ…Ø§ Ù‡ÙˆØŒ Ù…Ø´ Ø¨Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù‡Ù†Ø§) -->
  <script src="https://inapp.telega.io/sdk/v1/sdk.js"></script>
  <script>
    var telegaAds = null;
    if (window.TelegaIn && window.TelegaIn.AdsController) {
      telegaAds = window.TelegaIn.AdsController.create_miniapp({
        token: 'a14e3947-839f-4b2a-aee0-5a3b1412c818'
      });
    }

    const TELEG_UID_1024 = "3a1f1a7a-028c-4909-b20b-f4733d02fcc5";
    const TELEG_UID_2048 = "6a5cb9ac-15d0-4da2-bbca-916236f1bc83";

    function showTelega(uid) {
      try {
        if (window.ads && typeof window.ads.ad_show === "function") {
          return window.ads.ad_show({ adBlockUuid: uid });
        } else if (telegaAds && typeof telegaAds.show === "function") {
          return telegaAds.show();
        }
      } catch(e) { console.warn("Telega show error:", e); }
      return Promise.resolve();
    }
  </script>

  <style>
    :root{
      --bg:#faf8ef;
      --board:#bbada0;
      --tile:#cdc1b4;
      --text:#776e65;
      --btn:#8f7a66;
      --white:#fff;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial;padding:16px;margin:0;background:var(--bg);color:var(--text);}
    .wrap{max-width:480px;margin:0 auto;position:relative}
    h1{margin:0 0 8px;font-size:32px;line-height:1.1;padding-right:50px}

    .top{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .card{background:var(--board);color:var(--white);border-radius:12px;padding:8px 12px;min-width:100px;text-align:center}

    .grid{background:var(--board);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;touch-action:none}
    .cell{height:80px;background:var(--tile);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px}

    /* Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø© */
    button{
      padding:10px 12px;border:0;border-radius:12px;font-weight:700;background:var(--btn);color:var(--white);cursor:pointer;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª ÙÙ‚Ø· */
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px;justify-items:center;align-items:center}
    .controls .spacer{height:0}
    .arrow{min-width:96px;min-height:66px;font-size:20px}

    /* Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„ØµØºÙŠØ± */
    .menuBtn{
      position:absolute; top:8px; right:8px;
      width:32px; height:32px; padding:0;
      min-width:0; min-height:0; line-height:1;
      background:transparent; color:var(--btn);
      border:2px solid var(--btn); border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:900; z-index:11;
    }

    /* Ø§Ù„Ù€ Drawer */
    .backdrop{position:fixed; inset:0; background:#0007; display:none;}
    .backdrop.show{ display:block; }

    .drawer{
      position:fixed; top:0; right:0; height:100dvh; width:220px;
      background:#f5efe6; box-shadow:0 0 30px #0003; padding:16px 14px;
      transform: translateX(100%); transition: transform .25s ease; z-index:12;
    }
    .drawer.open{ transform: translateX(0); }
    .drawer h3{margin:4px 0 12px}
    .menuItem{display:block;width:100%;margin:8px 0;padding:12px 14px;background:var(--btn);color:#fff;border:0;border-radius:12px;font-weight:700;cursor:pointer}
    .menuInfo{margin:6px 0 10px;font-weight:700;color:#333}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    small{opacity:.7}
  </style>
</head>
<body>
<div class="wrap">
  <h1>2048 Mini</h1>
  <button id="menuBtn" class="menuBtn" aria-label="Menu">â˜°</button>

  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="controls">
    <span class="spacer"></span>
    <button id="up" class="arrow">â–²</button>
    <span class="spacer"></span>

    <button id="left" class="arrow">â—€</button>
    <button id="down" class="arrow">â–¼</button>
    <button id="right" class="arrow">â–¶</button>
  </div>

  <p><small>Swipe on the board or use the arrows. MVP build.</small></p>
</div>

<!-- Drawer -->
<div id="backdrop" class="backdrop"></div>
<div id="drawer" class="drawer">
  <h3>Menu</h3>

  <!-- âœ… Balance ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ -->
  <div class="menuInfo">Balance (USDT): <span id="balance" class="mono">0.0000</span></div>

  <button id="mNew" class="menuItem">New Game</button>
  <button id="mInvite" class="menuItem">Invite Friend</button>
  <button id="mShare" class="menuItem">Share</button>
  <button id="mAbout" class="menuItem">About</button>
</div>

<script>
/* ===== Telegram ===== */
const tg = window.Telegram?.WebApp; if (tg) tg.expand();

/* ===== Game State ===== */
const size=4; let grid=[], score=0, best=+localStorage.getItem('best2048')||0;
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');

/* ===== Balance / Rewards ===== */
const balanceEl = document.getElementById('balance');
function getBalance(){ return +(localStorage.getItem('usdBalance')||'0'); }
function setBalance(v){
  const fixed = Math.max(0, v);
  localStorage.setItem('usdBalance', fixed.toFixed(4));
  updateBalanceUI();
}
function updateBalanceUI(){ balanceEl.textContent = (+localStorage.getItem('usdBalance')||0).toFixed(4); }
updateBalanceUI();

/* ========= Extra Lives (ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø¦Ù… + Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠ) ========= */
function getExtraLives(){ return +(localStorage.getItem('extraLives')||'0'); }
function setExtraLives(v){
  const n = Math.max(0, v|0);
  localStorage.setItem('extraLives', String(n));
  extraLives = n;
}
let extraLives = getExtraLives(); // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨ÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª

/* Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ø£Ø³Ø§Ø³ */
const baseRewards = {
  256: 0.0002,
  512: 0.0003,
  1024: 0.0015,
  2048: 0.002
};

/* ÙÙ„Ù‘Ø§Ø¬Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø¬ÙŠÙ…) */
let awardedRun = { 256:false, 512:false, 1024:false, 2048:false };

/* Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„ÙƒÙ„ Ù…ÙŠÙ„Ø³ØªÙˆÙ† Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ Ù…Ø±Ø©/Ù†Øµ Ø§Ù„Ù‚ÙŠÙ…Ø© */
function getMsCount(ms){ return +(localStorage.getItem('msCount_'+ms)||'0'); }
function incMsCount(ms){ localStorage.setItem('msCount_'+ms, String(getMsCount(ms)+1)); }

/* ===== AdsGram: interstitial & rewarded ===== */
let AdController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  AdController = window.Adsgram.init({ blockId: "int-14155" });
}
function showInterstitialAd(){
  if (!AdController || typeof AdController.show !== "function") return Promise.resolve();
  return AdController.show().catch(()=>{});
}
let RewardController = null;
if (window.Adsgram && typeof window.Adsgram.init === "function") {
  RewardController = window.Adsgram.init({ blockId: "14159" }); // Reward block
}
function showRewardAd(){
  if (!RewardController || typeof RewardController.show !== "function") {
    return Promise.resolve(false);
  }
  return RewardController.show()
    .then(()=> true)
    .catch(()=> false);
}

/* ===== Ù…Ù†Ø·Ù‚ ØµØ±Ù Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ù…Ø±Ø©/Ø¬ÙŠÙ… + Ù†ØµÙ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§) ===== */
function tryAwardMilestone(ms){
  if (awardedRun[ms]) return; // Ø¨Ø§Ù„ÙØ¹Ù„ Ø§ØªØµØ±Ù ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¯ÙŠ
  const base = baseRewards[ms];
  if (!base) return;

  // Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ§Ø±ÙŠØ®ÙŠÙ‹Ø§ = ÙƒØ§Ù…Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©ØŒ ØºÙŠØ± ÙƒØ¯Ù‡ = Ù†Øµ Ø§Ù„Ù‚ÙŠÙ…Ø©
  const historicalCount = getMsCount(ms);
  const amount = historicalCount === 0 ? base : base/2;

  // Ù„Ø§Ø²Ù… Ø¥Ø¹Ù„Ø§Ù† Rewarded ÙŠÙ†Ø¬Ø­
  showRewardAd().then(ok=>{
    if (!ok) return;
    awardedRun[ms] = true;
    incMsCount(ms);

    // Ø£Ø¶Ù Ø§Ù„Ø±ØµÙŠØ¯
    const newBal = getBalance() + amount;
    setBalance(newBal);

    // âœ… Extra life Ø¹Ù†Ø¯ 512 Ùˆ 2048 (ØªØªØ®Ø²Ù† Ø¯Ø§Ø¦Ù…Ù‹Ø§)
    if (ms === 512 || ms === 2048) {
      setExtraLives(getExtraLives() + 1);
    }

    // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ·
    alert(`âœ… Reward added: $${amount.toFixed(4)}${(ms===512||ms===2048)?' + Extra Life':''}`);
  });
}

/* ===== Flags Ø£Ø®Ø±Ù‰ Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ===== */
let continuedOnce = false;
let shown1024Ad = false;
let shown2048Ad = false;

/* ===== Core game ===== */
function emptyGrid(){grid=Array.from({length:size},()=>Array(size).fill(0));}
function randomEmpty(){const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])e.push([r,c]); return e.length?e[Math.floor(Math.random()*e.length)]:null;}
function addTile(){const pos=randomEmpty(); if(!pos) return false; grid[pos[0]][pos[1]] = Math.random()<0.9?2:4; return true;}
function setup(){
  emptyGrid(); addTile(); addTile();
  score=0;
  continuedOnce=false; shown1024Ad=false; shown2048Ad=false;
  awardedRun = {256:false,512:false,1024:false,2048:false}; // reset per-run flags
  draw();
}

function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||'';
    d.style.background=v?tileColor(v):'#cdc1b4';
    d.style.color=v>=8?'#f9f6f2':'#776e65';
    gridEl.appendChild(d);

    // ØªØ´ØºÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Telega Ù„Ù„Ù…ÙŠÙ„Ø³ØªÙˆÙ† (Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡Ø§ ØªÙØ¶Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ)
    if (v === 1024 && !shown1024Ad) { shown1024Ad = true; showTelega(TELEG_UID_1024); }
    if (v === 2048 && !shown2048Ad) { shown2048Ad = true; showTelega(TELEG_UID_2048); }

    // ğŸ”” Ù…ÙƒØ§ÙØ¢Øª AdsGram Rewarded (Ù…Ø±Ù‘Ø©/Ø¬ÙŠÙ…ØŒ ÙˆÙ†Øµ ÙÙŠ Ø§Ù„Ø¬ÙŠÙ…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©)
    if (v === 256 && !awardedRun[256])  tryAwardMilestone(256);
    if (v === 512 && !awardedRun[512])  tryAwardMilestone(512);
    if (v === 1024 && !awardedRun[1024]) tryAwardMilestone(1024);
    if (v === 2048 && !awardedRun[2048]) tryAwardMilestone(2048);
  }
}
function tileColor(v){
  const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
  return m[v]||'#3c3a32';
}
function slide(row){
  const f=row.filter(x=>x);
  for(let i=0;i<f.length-1;i++){
    if(f[i]===f[i+1]){ f[i]*=2; score+=f[i]; f.splice(i+1,1); }
  }
  while(f.length<size) f.push(0);
  return f;
}
function rotate(times){
  for(let t=0;t<times;t++){
    const g=Array.from({length:size},()=>Array(size).fill(0));
    for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c];
    grid=g;
  }
}

/* Directions */
function move(dir){
  const before = JSON.stringify(grid);
  if (dir === 2) rotate(2); else if (dir === 1) rotate(3); else if (dir === 3) rotate(1);
  for (let r=0;r<size;r++) grid[r] = slide(grid[r]);
  if (dir === 2) rotate(2); else if (dir === 1) rotate(1); else if (dir === 3) rotate(3);
  const after = JSON.stringify(grid);
  if (before !== after) { addTile(); updateBest(); draw(); if (gameOver()) endGame(); }
}

function gameOver(){
  if(randomEmpty()) return false;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    if(r+1<size && grid[r+1][c]===v) return false;
    if(c+1<size && grid[r][c+1]===v) return false;
  }
  return true;
}
function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048', best); }}

/* Inputs */
const startPos={x:0,y:0}; let dragging=false;
function touchStart(e){dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY;}
function touchEnd(e){
  if(!dragging) return; dragging=false;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y;
  if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?2:0); } else { move(dy>0?3:1); }
}
gridEl.addEventListener('touchstart',touchStart); gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart); gridEl.addEventListener('mouseup',touchEnd);

document.getElementById('left').onclick=()=>move(0);
document.getElementById('up').onclick=()=>move(1);
document.getElementById('right').onclick=()=>move(2);
document.getElementById('down').onclick=()=>move(3);

/* Drawer control */
const menuBtn=document.getElementById('menuBtn');
const drawer=document.getElementById('drawer');
const backdrop=document.getElementById('backdrop');
function openDrawer(){ drawer.classList.add('open'); backdrop.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); }
menuBtn.addEventListener('click', openDrawer);
backdrop.addEventListener('click', closeDrawer);

document.getElementById('mNew').onclick=()=>{ closeDrawer(); setup(); };
document.getElementById('mInvite').onclick=()=>{ closeDrawer(); prompt('Copy link:','https://t.me/Smart2048_bot'); };
document.getElementById('mShare').onclick=()=>{ closeDrawer(); const text=`I scored ${score} in 2048 Mini!`; if(navigator.share){navigator.share({text});} else {prompt('Copy and share your score:', text);} };
document.getElementById('mAbout').onclick=()=>{ closeDrawer(); alert('2048 Mini â€” MVP.'); };

/* Revive + end (Ù…Ø¹ Ø±Ø¨Ø· extraLives ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§) */
function reviveBoard(){
  const filled=[];
  for(let r=0;r<size;r++) for(let c=0;c<size;c++){ if(grid[r][c]!==0) filled.push([r,c]); }
  if(filled.length){ const [rr,cc]=filled[Math.floor(Math.random()*filled.length)]; grid[rr][cc]=0; }
  updateBest();
}
function endGame(){
  // âœ… Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Extra Life Ø§ØªØµØ±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£ÙˆÙ„Ù‹Ø§ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¥Ø¹Ù„Ø§Ù†
  if (getExtraLives() > 0) {
    setExtraLives(getExtraLives() - 1);  // Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù„Ø§ÙŠÙ ÙˆØ§Ø­Ø¯
    reviveBoard();
    draw();
    alert('ğŸ”¥ Extra Life used! You are back in the game.');
    return;
  }

  if(!continuedOnce&&RewardController){
    const wantContinue=confirm("Game over! Your score: "+score+"\n\nWatch an ad to continue?");
    if (wantContinue){
      showRewardAd().then(ok=>{
        if(ok){ continuedOnce=true; reviveBoard(); draw(); }
        else { showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score)); }
      });
      return;
    } else {
      showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
      return;
    }
  }
  showInterstitialAd().finally(()=> alert("Game ended! Final score: " + score));
}

/* Start */
setup();

/* (ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø·ÙˆØ± ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø´ÙŠØ¡) */
document.getElementById('mNew');
document.getElementById('mInvite');
document.getElementById('mShare');
document.getElementById('mAbout');
</script>
</body>
</html>
