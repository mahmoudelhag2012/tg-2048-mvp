<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2048 Mini — MVP</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- AdsGram SDK (الصحيح) -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

  <style>
    body{font-family:system-ui,Arial;padding:16px;margin:0;background:#faf8ef;color:#776e65;}
    .wrap{max-width:420px;margin:0 auto;text-align:center}
    h1{margin:0 0 8px}
    .top{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .card{background:#bbada0;color:#fff;border-radius:12px;padding:8px 12px;min-width:100px}
    .grid{background:#bbada0;border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;touch-action:none}
    .cell{height:80px;background:#cdc1b4;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px}
    .btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    button{padding:10px;border:0;border-radius:10px;font-weight:700;background:#8f7a66;color:#fff}
    small{opacity:.7}
  </style>
</head>
<body>
<div class="wrap">
  <h1>2048 Mini</h1>
  <div class="top">
    <div class="card">Score<br><b id="score">0</b></div>
    <div class="card">Best<br><b id="best">0</b></div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="btns">
    <span></span><button id="up">▲</button><span></span>
    <button id="left">◀</button><button id="down">▼</button><button id="right">▶</button>
    <button id="new">لعبة جديدة</button><button id="share">مشاركة</button><button id="about">عن اللعبة</button>
  </div>
  <p><small>اسحب على اللوحة أو استخدم الأزرار. نسخة MVP.</small></p>
</div>

<script>
/* ===== Telegram ===== */
const tg = window.Telegram?.WebApp; if (tg) { tg.expand(); }

/* ===== Game State ===== */
const size=4; let grid=[], score=0, best=+localStorage.getItem('best2048')||0;
const gridEl=document.getElementById('grid'); const scoreEl=document.getElementById('score'); const bestEl=document.getElementById('best');

function emptyGrid(){grid=Array.from({length:size},()=>Array(size).fill(0));}
function randomEmpty(){const e=[]; for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])e.push([r,c]); return e.length?e[Math.floor(Math.random()*e.length)]:null;}
function addTile(){const pos=randomEmpty(); if(!pos) return false; grid[pos[0]][pos[1]] = Math.random()<0.9?2:4; return true;}
function setup(){emptyGrid(); addTile(); addTile(); score=0; draw();}
function draw(){
  gridEl.innerHTML=''; scoreEl.textContent=score; bestEl.textContent=best;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    const d=document.createElement('div'); d.className='cell'; d.textContent=v||'';
    d.style.background=v?tileColor(v):'#cdc1b4';
    d.style.color=v>=8?'#f9f6f2':'#776e65';
    gridEl.appendChild(d);
  }
}
function tileColor(v){
  const m={2:'#eee4da',4:'#ede0c8',8:'#f2b179',16:'#f59563',32:'#f67c5f',64:'#f65e3b',128:'#edcf72',256:'#edcc61',512:'#edc850',1024:'#edc53f',2048:'#edc22e'};
  return m[v]||'#3c3a32';
}
function slide(row){
  const f=row.filter(x=>x);
  for(let i=0;i<f.length-1;i++){
    if(f[i]===f[i+1]){ f[i]*=2; score+=f[i]; f.splice(i+1,1); }
  }
  while(f.length<size) f.push(0);
  return f;
}
function rotate(times){
  for(let t=0;t<times;t++){
    const g=Array.from({length:size},()=>Array(size).fill(0));
    for(let r=0;r<size;r++)for(let c=0;c<size;c++) g[c][size-1-r]=grid[r][c];
    grid=g;
  }
}
function move(dir){ // 0: left, 1: up, 2: right, 3: down
  const before=JSON.stringify(grid);
  if(dir===2){rotate(2);} else if(dir===1){rotate(1);} else if(dir===3){rotate(3);} // slide left
  for(let r=0;r<size;r++){ grid[r]=slide(grid[r]); }
  if(dir===2){rotate(2);} else if(dir===1){rotate(3);} else if(dir===3){rotate(1);} // rotate back
  const after=JSON.stringify(grid);
  if(before!==after){ addTile(); updateBest(); draw(); if(gameOver()) endGame(); }
}
function gameOver(){
  if(randomEmpty()) return false; // أي صفر؟
  // أي دمج محتمل؟
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const v=grid[r][c];
    if(r+1<size && grid[r+1][c]===v) return false;
    if(c+1<size && grid[r][c+1]===v) return false;
  }
  return true;
}
function updateBest(){ if(score>best){ best=score; localStorage.setItem('best2048', best); }}

/* ===== Inputs ===== */
const startPos={x:0,y:0}; let dragging=false;
function touchStart(e){dragging=true; const t=e.touches?e.touches[0]:e; startPos.x=t.clientX; startPos.y=t.clientY;}
function touchEnd(e){
  if(!dragging) return; dragging=false;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const dx=t.clientX-startPos.x, dy=t.clientY-startPos.y;
  if(Math.abs(dx)>Math.abs(dy)){ move(dx>0?2:0); } else { move(dy>0?3:1); }
}
document.getElementById('left').onclick=()=>move(0);
document.getElementById('up').onclick=()=>move(1);
document.getElementById('right').onclick=()=>move(2);
document.getElementById('down').onclick=()=>move(3);
document.getElementById('new').onclick=()=>setup();
document.getElementById('about').onclick=()=>alert('2048 Mini — MVP.');
document.getElementById('share').onclick=()=>{
  const text=`جبت اسكور ${score} في 2048 Mini!`;
  if(navigator.share){navigator.share({text});}
  else {prompt('انسخ وشارك نتيجتك:', text);}
};
gridEl.addEventListener('touchstart',touchStart); gridEl.addEventListener('touchend',touchEnd);
gridEl.addEventListener('mousedown',touchStart); gridEl.addEventListener('mouseup',touchEnd);

/* ===== AdsGram: init + عرض الإعلان عند نهاية اللعبة ===== */
let AdController = null;
window.Adsgram && (AdController = window.Adsgram.init({ blockId: "int-14155" }));

function showInterstitialAd(){
  // لو SDK/الكونترولر مش جاهز، رجّع Promise فاضي عشان مايكسرش اللعبة
  if (!window.Adsgram || !AdController || typeof AdController.show !== "function") {
    return Promise.resolve();
  }
  return AdController.show()
    .then(res => { console.log("Ad shown/closed:", res); })
    .catch(err => { console.warn("Ad show error:", err); });
}

function endGame(){
  // اعرض الإعلان ثم أظهر رسالة النتيجة
  showInterstitialAd().finally(()=>{
    alert('انتهت اللعبة! نتيجتك: ' + score);
  });
}

setup();
</script>
</body>
</html>
